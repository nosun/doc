##空气盒子微信开发方案

    author: nosun
    date  : 2015-03-12
    ver   : 1.1   
    change log：
        1、增加数据结构说明
        2、增加微信功能：查看关注我的设备的微信用户的功能。
        3、增加部分接口需求。

###一、功能需求
空气盒子是海尔的一款智能硬件产品，能够通过手机对其进行远程控制，并通过云平台获取盒子上报的空气质量数据，目前需要将数据通过微信端展示出来，方便用户查看，分享，关注，实现围绕该硬件产生的空气质量数据，将社交元素融入其中，起到宣传，推广的功能，让更多的用户了解该产品，同时也多提供了用户了解设备数据的方式。

**需求分析：**
- App软件增加分享页面，分享页面包含四方面元素：
    - 当前被分享设备的当前数据值：所在地区，天气，室外温度，室内温度，室外pm，室内pm，室外湿度，室内湿度，当前家中的空气质量等级，以及温馨提示。
    - 分享二维码：二维码是根据一定的规则生成的该设备唯一标识。
    - 微信公众号：微信公众号“关注链接”，通过点击该链接，关注该公众号。
    - 简易说明：告知关注公众号，可以做什么，很好玩什么的。  
    
- 微信分享，主要提供以下功能：    
    - 菜单
        - 我的盒子（主菜单）
            - 盒子列表(网页):查看
            - 盒子详情(网页)：查看，分享，取消分享
            - 关注列表(网页)：查看关注我设备的微信用户（用户昵称）
        - 我的关注
            - 添加关注
            - 盒子列表(网页)：查看，删除;
            - 盒子详情(网页): 查看，分享;
        - 客服中心
            - 意见反馈(微信互动，客服支持)     
            - 帮助手册(可有可无)

### 二、解决方案

#### 2.1 服务端开发
服务器端开发分为微信服务和web服务两个层面，一个是与微信官方的服务端进行交互的服务端，另一个是需要盒子服务端开发为数据展示，分享提供服务。

- 微信服务
   - 微信服务平台构建（基础服务开发，包含生成菜单，命令交互等）
   - 微信服务平台管理后台（可放在后期）   

- web服务
    - 账号关联：将微信的用户openid 与 用户在盒子服务端的账号进行绑定，当用户需要查看我的盒子的时候，首先做的是进行登录，以及注册。
    - 设备分享token生成规则：出于安全考虑，不能反向破解真实device_id即可
    - 二维码生成:将token生成二维码
    - 动态网页：为分享功能提供后端服务支持。
    - 根据前端展示的需求，增加API接口。

#### 2.2 网页端开发
主要是微信端展示的分享页面以及用户操作过程中的交互，上传二维码，识别二维码，页面跳转，消息提示，登录页面的表单提示，验证等。

- 分享页面：根据app风格以及呈现内容设计
- 登录页面：在添加设备时，提示用户登录，登录之后，将该用户账号与微信账号绑定，此处较为复杂。
- 盒子列表：关注的盒子，我的盒子，两类列表
- 用户列表：获取关注我的盒子的用户的列表
- 盒子详情：展示盒子数据，提供分享按钮。关注的盒子，我的盒子，两类页面。
- 添加关注：上传二维码，识别二维码，关注设备，成功或者失败的提示。

#### 2.3 数据结构设计

- 服务器端需要建立微信用户与云平台注册用户绑定关系的表，从而实现当用户登录微信，从而授权该用户享有登录云平台后的权限
- 主人分享设备，即设置设备表，允许该设备被分享。
- 主人取消分享设备，即设置设备表，禁止改设备被分享，设备默认禁止被分享。
- 用户关注某设备，可以得到用户与设备的关注关系，用户信息是用户在微信平台上的openid并与设备之间建立关注关系。
- 用户取消关注某设备，即将该openid与设备的绑定关系记录删除。
- 主人取消某用户关注改设备，即将该openid与该设备的绑定关系记录删除，并且增加一条禁止绑定关系的记录。
- 服务器端需要建立一个表，存放用户微信nickname与openid的关系，用于调取“设备被关注用户列表”。


#### 2.4 客户端开发
网页端开发之后，客户端这边主要是增加一个“我要分享”的按钮即可，点击该按钮，服务器端返回设备的分享页面的url，即可进行分享，放在最后实现。

### 三、商榷之处
主要是微信服务与web服务对接层面上的，需要沟通一下：
- 目前空气盒子有云平台服务器，对外开放功能接口，在此项目中，至少需要的接口如下：
    - 用户登录接口
    - 根据条件获取设备列表接口
    - 获取设备当前采集数据，状态的接口
    - 主人分享设备
    - 主人取消分享设备
    - 主人设置禁止某人关注设备
    - 主人取消禁止某人关注设备
    - 查看某设备，被禁止关注用户列表
    - 获取设备被关注的用户的openid列表
    - 获取设备禁止被关注的用户的对应关系列表
    - 设置用户关注设备
    - 设置用户取消关注设备
    - device_id分享时按照一定规则进行加密可以由我方做，也可以放在云平台上，需要商榷，如果设备处于公开状态（即被分享状态），则通过加密的device_id(且成为device_token)可以访问到该设备的数据信息。
    - 微信账号和用户账号的绑定：涉及云平台的账户系统，需要增加微信openID，以及实现openID与token的关联。
